<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBRN Keemiaarvuti: ERG 2024</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #e0e0e0;
            --accent: #0a84ff;
            --danger: #ff453a; /* Hot Zone Red */
            --warn: #ff9f0a;   /* PAZ Orange */
            --border: #333;
        }

        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; }

        /* LAYOUT */
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* MAP LAYER */
        #map { flex-grow: 1; z-index: 1; background: #222; }

        /* UI OVERLAY (Tactical Interface) */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--accent);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
            transition: transform 0.3s ease;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        /* HEADER & SEARCH */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px; box-sizing: border-box;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            z-index: 1001; pointer-events: none;
        }
        .search-container { pointer-events: auto; display: flex; gap: 10px; }
        input#search {
            flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444;
            background: rgba(0,0,0,0.8); color: white; font-size: 16px;
        }
        button#btn-li-ion {
            background: #ff3b30; color: white; border: none; border-radius: 8px;
            font-weight: bold; padding: 0 15px; font-size: 14px;
        }

        /* CONTROLS */
        .controls { padding: 15px; }
        .row { display: flex; gap: 10px; margin-bottom: 12px; }
        .col { flex: 1; }

        label { font-size: 11px; text-transform: uppercase; color: #888; display: block; margin-bottom: 5px; }
        
        /* SEGMENTED CONTROLS */
        .seg-control { display: flex; background: #333; border-radius: 8px; padding: 2px; }
        .seg-btn {
            flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 600;
            color: #888; border-radius: 6px; cursor: pointer; transition: 0.2s;
        }
        .seg-btn.active { background: #555; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .seg-btn.active.danger { background: var(--danger); }

        /* WIND SLIDER */
        input[type=range] { width: 100%; accent-color: var(--accent); }
        .wind-val { float: right; color: var(--accent); font-weight: bold; }

        /* INFO PANEL */
        .info-panel {
            background: #252525; padding: 15px; border-radius: 8px; margin-top: 10px;
            border-left: 4px solid var(--accent);
        }
        .chem-title { font-size: 18px; font-weight: 800; margin: 0; }
        .chem-un { font-family: monospace; color: var(--accent); font-size: 14px; }
        .zone-data { display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px; }
        .val-hot { color: var(--danger); font-weight: bold; }
        .val-warm { color: var(--warn); font-weight: bold; }

        /* CWA WARNING */
        .cwa-alert {
            background: #2e003e; border: 1px solid #d500f9; color: #fff;
            padding: 10px; margin-bottom: 10px; border-radius: 6px;
            font-weight: bold; text-align: center; display: none;
        }

    </style>
</head>
<body>

<div id="app-container">
    
    <div class="top-bar">
        <div class="search-container">
            <input type="text" id="search" placeholder="UN kood v√µi Nimi (nt 1017, Kloor)..." onchange="findChem()">
            <button id="btn-li-ion" onclick="activateLithiumMode()">üîã Li-Ion</button>
        </div>
    </div>

    <div id="map"></div>

    <div id="ui-layer">
        <div class="controls">
            
            <div id="cwa-banner" class="cwa-alert">‚ö†Ô∏è R√úNDEM√úRK (CWA) - TERRORIOHT</div>

            <div class="info-panel" id="info-box" style="display:none">
                <div class="chem-un" id="disp-un">UN ----</div>
                <h2 class="chem-title" id="disp-name">Vali aine</h2>
                <div class="zone-data">
                    <span>Eralda (Hot): <span id="val-iso" class="val-hot">-- m</span></span>
                    <span>Kaitse (PAZ): <span id="val-paz" class="val-warm">-- km</span></span>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">

            <div class="row">
                <div class="col">
                    <label>Lekke suurus</label>
                    <div class="seg-control">
                        <div class="seg-btn active" id="btn-small" onclick="setSpill('small')">V√ÑIKE<br><span style="font-size:9px">< 208L</span></div>
                        <div class="seg-btn" id="btn-large" onclick="setSpill('large')">SUUR<br><span style="font-size:9px">> 208L</span></div>
                    </div>
                </div>
                <div class="col">
                    <label>Aeg / Ilm</label>
                    <div class="seg-control">
                        <div class="seg-btn active" id="btn-day" onclick="setTime('day')">P√ÑEV</div>
                        <div class="seg-btn" id="btn-night" onclick="setTime('night')">√ñ√ñ</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Tuule suund (Kuhu puhub): <span id="wind-disp" class="wind-val">0¬∞ (N)</span></label>
                    <input type="range" id="wind-slider" min="0" max="360" value="0" oninput="updateWind(this.value)">
                    <div style="font-size:10px; color:#666; text-align:center; margin-top:5px">P√∂√∂ra liugurit vastavalt tuulele</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    // --- 1. DATA SOVEREIGNTY (JSON DATABASE) ---
    // Expanded structure to support ERG 2024 logic
    const db = [
        {
            un: "1005", name: "AMMONIAAK (Veevaba)", type: "tic",
            iso_s: 30, paz_s_d: 0.1, paz_s_n: 0.2,
            iso_l: 150, paz_l_d: 0.8, paz_l_n: 2.3
        },
        {
            un: "1017", name: "KLOOR", type: "tic",
            iso_s: 60, paz_s_d: 0.2, paz_s_n: 0.8,
            iso_l: 270, paz_l_d: 1.6, paz_l_n: 6.8
        },
        {
            un: "1076", name: "FOSGEEN", type: "tic",
            iso_s: 100, paz_s_d: 0.8, paz_s_n: 2.7,
            iso_l: 600, paz_l_d: 5.3, paz_l_n: 11.0
        },
        {
            un: "2810", name: "SARIIN (GB)", type: "cwa", // CWA triggers special UI
            iso_s: 60, paz_s_d: 0.4, paz_s_n: 1.1,
            iso_l: 300, paz_l_d: 2.1, paz_l_n: 8.5
        },
        {
            un: "2810", name: "VX AINE", type: "cwa",
            iso_s: 30, paz_s_d: 0.1, paz_s_n: 0.2,
            iso_l: 60, paz_l_d: 0.2, paz_l_n: 0.2
        },
        {
            un: "1051", name: "VESINIKTS√úANIID", type: "tic",
            iso_s: 30, paz_s_d: 0.1, paz_s_n: 0.2,
            iso_l: 100, paz_l_d: 0.5, paz_l_n: 1.7
        }
    ];

    // --- 2. APP STATE ---
    let map, hotLayer, pazLayer;
    let currentChem = null;
    let state = {
        spill: 'small', // small, large
        time: 'day',    // day, night
        wind: 0,        // degrees (0-360)
        center: [59.437, 24.7535] // Default Tallinn
    };

    // --- 3. INITIALIZATION ---
    function init() {
        // Init Leaflet Map
        map = L.map('map').setView(state.center, 13);
        
        // Dark Mode Tiles (CartoDB DarkMatter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Get Real GPS
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                state.center = [pos.coords.latitude, pos.coords.longitude];
                map.setView(state.center, 15);
                L.marker(state.center).addTo(map).bindPopup("Sinu asukoht").openPopup();
            });
        }
    }

    // --- 4. GEOSPATIAL ALGORITHMIC RENDERING ("Keyhole" Logic) ---
    function drawZones() {
        if (!currentChem) return;

        // Clear old layers
        if (hotLayer) map.removeLayer(hotLayer);
        if (pazLayer) map.removeLayer(pazLayer);

        // 1. Determine Distances based on Matrix (Small/Large + Day/Night)
        let r_iso = (state.spill === 'small') ? currentChem.iso_s : currentChem.iso_l; // Meters
        let d_paz_km = 0;

        if (state.spill === 'small') {
            d_paz_km = (state.time === 'day') ? currentChem.paz_s_d : currentChem.paz_s_n;
        } else {
            d_paz_km = (state.time === 'day') ? currentChem.paz_l_d : currentChem.paz_l_n;
        }
        let d_paz = d_paz_km * 1000; // Convert to meters

        // Update UI Text
        document.getElementById('val-iso').innerText = r_iso + " m";
        document.getElementById('val-paz').innerText = d_paz_km + " km";

        // 2. Draw HOT ZONE (Circle) - Red
        hotLayer = L.circle(state.center, {
            color: 'var(--danger)',
            fillColor: '#f03',
            fillOpacity: 0.4,
            radius: r_iso
        }).addTo(map);

        // 3. Draw PAZ (Protective Action Zone) - "Keyhole" Cone using Turf.js
        // The PAZ starts at the spill and extends downwind.
        // We create a polygon: Center -> Tangent Left -> Downwind Left -> Downwind Right -> Tangent Right -> Center
        
        const centerPt = turf.point([state.center[1], state.center[0]]); // GeoJSON is Lon, Lat
        const windBearing = parseInt(state.wind);
        const coneWidth = 45; // Degrees spread (Standard ERG approach)

        // Calculate polygon points
        // NOTE: Turf uses degrees from North (0 is North, 90 is East)
        const p1 = turf.destination(centerPt, r_iso/1000, windBearing - 90); // Tangent approx
        const p2 = turf.destination(centerPt, d_paz_km, windBearing - coneWidth/2); // Far Left
        const p3 = turf.destination(centerPt, d_paz_km, windBearing + coneWidth/2); // Far Right
        const p4 = turf.destination(centerPt, r_iso/1000, windBearing + 90); // Tangent approx

        // In a real precise app, we would calculate exact tangents to the circle. 
        // For ERG visualization, a cone originating from center overlaid by the circle is standard.
        
        const polyCoords = [
            [state.center[1], state.center[0]], // Start at center
            p2.geometry.coordinates,
            p3.geometry.coordinates,
            [state.center[1], state.center[0]]  // Close loop
        ];

        // Convert Turf polygon to Leaflet
        const leafCoords = polyCoords.map(c => [c[1], c[0]]); // Swap back to Lat, Lon

        pazLayer = L.polygon(leafCoords, {
            color: 'var(--warn)',
            fillColor: '#ff9f0a',
            fillOpacity: 0.3,
            weight: 2
        }).addTo(map);

        // Fit bounds to see the whole danger area
        const group = new L.featureGroup([hotLayer, pazLayer]);
        map.fitBounds(group.getBounds(), {padding: [50, 50]});
    }

    // --- 5. LOGIC & UI HANDLERS ---
    
    function findChem() {
        const query = document.getElementById('search').value.toLowerCase();
        const found = db.find(i => i.un.includes(query) || i.name.toLowerCase().includes(query));

        if (found) {
            currentChem = found;
            document.getElementById('info-box').style.display = 'block';
            document.getElementById('disp-name').innerText = found.name;
            document.getElementById('disp-un').innerText = "UN " + found.un;

            // CWA Check (Section 2.2)
            const cwaBanner = document.getElementById('cwa-banner');
            if (found.type === 'cwa') {
                cwaBanner.style.display = 'block';
                document.getElementById('info-box').style.borderColor = '#d500f9'; // Purple border
            } else {
                cwaBanner.style.display = 'none';
                document.getElementById('info-box').style.borderColor = 'var(--accent)';
            }

            drawZones();
        }
    }

    function setSpill(val) {
        state.spill = val;
        toggleBtns('btn-small', 'btn-large', val);
        drawZones();
    }

    function setTime(val) {
        state.time = val;
        toggleBtns('btn-day', 'btn-night', val);
        drawZones();
    }

    function updateWind(val) {
        state.wind = val;
        // Direction text logic
        let dirTxt = "N";
        if (val > 22 && val <= 67) dirTxt = "NE";
        if (val > 67 && val <= 112) dirTxt = "E";
        if (val > 112 && val <= 157) dirTxt = "SE";
        if (val > 157 && val <= 202) dirTxt = "S";
        if (val > 202 && val <= 247) dirTxt = "SW";
        if (val > 247 && val <= 292) dirTxt = "W";
        if (val > 292 && val <= 337) dirTxt = "NW";
        
        document.getElementById('wind-disp').innerText = `${val}¬∞ (${dirTxt})`;
        drawZones();
    }

    function toggleBtns(id1, id2, val) {
        document.getElementById(id1).classList.remove('active');
        document.getElementById(id2).classList.remove('active');
        if (val === 'small' || val === 'day') document.getElementById(id1).classList.add('active');
        else document.getElementById(id2).classList.add('active');
    }

    // Guide 147 (Li-Ion)
    function activateLithiumMode() {
        alert("LITHIUM-ION RE≈ΩIIM (Guide 147):\n1. Vesi: Kasuta suures koguses jahutamiseks.\n2. Oht: Taass√ºttimine v√µimalik 24h jooksul.\n3. Eralda: V√§hemalt 15m teistest objektidest.");
    }

    // Start
    init();

</script>
</body>
</html>
